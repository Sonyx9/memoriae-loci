---
interface Props {
  coverImage?: string;
  cover?: { src: string; alt: string };
  gallery?: Array<{ src: string; alt: string }>;
  title: string;
}

const { coverImage, cover, gallery, title } = Astro.props;
const coverSrc = (() => {
  const img = cover?.src || (coverImage && coverImage.trim());
  // Ignore non-existent files and placeholder.svg, use hero image as fallback
  if (!img || img === '/images/placeholder.svg' || img === '/images/liberec.png' || img === '/images/articles/example.jpg') {
    return '/images/liberec-hero.webp';
  }
  return img;
})();
const coverAlt = cover?.alt || title;
const allImages = coverSrc ? [{ src: coverSrc, alt: coverAlt }, ...(gallery || [])] : (gallery || []);
---

<div class="relative w-full h-full hero-media-container">
  <div class="relative w-full h-full">
    <img 
      src={coverSrc} 
      alt={coverAlt}
      class="w-full h-full object-cover hero-image min-h-0 lg:min-h-[100vh]"
      loading="eager"
    />
    <!-- Dark gradient overlay for better UI contrast -->
    <div class="absolute inset-0 bg-gradient-to-r from-slate-950/60 via-slate-950/30 to-transparent pointer-events-none"></div>
    <div class="absolute inset-0 bg-gradient-to-t from-slate-950/40 via-transparent to-transparent pointer-events-none"></div>
  </div>
  
  {gallery && gallery.length > 0 && (
    <div class="hidden lg:block absolute bottom-6 left-6 right-6 lg:bottom-8 lg:left-8 lg:right-8">
      <div class="flex gap-3 overflow-x-auto pb-2 scrollbar-hide">
        {gallery.map((img, index) => (
          <button 
            class="gallery-thumb flex-shrink-0 w-24 h-24 lg:w-28 lg:h-28 rounded overflow-hidden border-2 border-white/20 hover:border-white/40 transition-all hover:scale-105 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 focus:ring-offset-slate-950"
            data-gallery-index={index}
            data-gallery-src={img.src}
            data-gallery-alt={img.alt}
            aria-label={`Zobrazit obrázek ${index + 1}: ${img.alt}`}
          >
            <img 
              src={img.src} 
              alt={img.alt}
              class="w-full h-full object-cover"
              loading="lazy"
            />
          </button>
        ))}
      </div>
    </div>
  )}
</div>

<style>
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
  
  .hero-image {
    will-change: transform;
  }
</style>

<script>
  // Enhanced lightbox for gallery
  if (typeof window !== 'undefined') {
    document.addEventListener('DOMContentLoaded', () => {
      const thumbs = document.querySelectorAll('.gallery-thumb');
      let currentIndex = 0;
      let lightbox = null;
      const images = Array.from(thumbs).map(thumb => ({
        src: thumb.getAttribute('data-gallery-src') || '',
        alt: thumb.getAttribute('data-gallery-alt') || ''
      }));
      
      function createLightbox(index) {
        if (images.length === 0) return;
        
        currentIndex = index;
        const img = images[index];
        
        // Remove existing lightbox
        const existing = document.getElementById('gallery-lightbox');
        if (existing) existing.remove();
        
        // Create lightbox
        lightbox = document.createElement('div');
        lightbox.id = 'gallery-lightbox';
        lightbox.className = 'fixed inset-0 bg-slate-950/98 z-[100] flex items-center justify-center p-4';
        lightbox.setAttribute('role', 'dialog');
        lightbox.setAttribute('aria-label', 'Galerie obrázků');
        lightbox.setAttribute('aria-modal', 'true');
        
        const imgContainer = document.createElement('div');
        imgContainer.className = 'relative max-w-7xl max-h-full';
        
        const imgEl = document.createElement('img');
        imgEl.src = img.src;
        imgEl.alt = img.alt;
        imgEl.className = 'max-w-full max-h-[90vh] object-contain';
        
        // Close button
        const closeBtn = document.createElement('button');
        closeBtn.className = 'absolute top-4 right-4 text-slate-300 hover:text-white text-3xl leading-none w-10 h-10 flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-accent rounded';
        closeBtn.innerHTML = '×';
        closeBtn.setAttribute('aria-label', 'Zavřít');
        
        // Navigation buttons (if multiple images)
        let prevBtn = null;
        let nextBtn = null;
        
        if (images.length > 1) {
          prevBtn = document.createElement('button');
          prevBtn.className = 'absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 hover:text-white text-2xl w-12 h-12 flex items-center justify-center bg-slate-900/50 hover:bg-slate-900/80 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-accent';
          prevBtn.innerHTML = '←';
          prevBtn.setAttribute('aria-label', 'Předchozí obrázek');
          prevBtn.disabled = index === 0;
          
          nextBtn = document.createElement('button');
          nextBtn.className = 'absolute right-4 top-1/2 -translate-y-1/2 text-slate-300 hover:text-white text-2xl w-12 h-12 flex items-center justify-center bg-slate-900/50 hover:bg-slate-900/80 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-accent';
          nextBtn.innerHTML = '→';
          nextBtn.setAttribute('aria-label', 'Další obrázek');
          nextBtn.disabled = index === images.length - 1;
          
          // Counter
          const counter = document.createElement('div');
          counter.className = 'absolute bottom-4 left-1/2 -translate-x-1/2 text-slate-300 text-sm bg-slate-900/50 px-4 py-2 rounded';
          counter.textContent = `${index + 1} / ${images.length}`;
          imgContainer.appendChild(counter);
        }
        
        imgContainer.appendChild(imgEl);
        imgContainer.appendChild(closeBtn);
        if (prevBtn) imgContainer.appendChild(prevBtn);
        if (nextBtn) imgContainer.appendChild(nextBtn);
        lightbox.appendChild(imgContainer);
        document.body.appendChild(lightbox);
        document.body.style.overflow = 'hidden';
        
        // Focus trap
        closeBtn.focus();
        
        // Event handlers
        const closeLightbox = () => {
          if (lightbox) {
            lightbox.remove();
            lightbox = null;
            document.body.style.overflow = '';
            document.removeEventListener('keydown', keyHandler);
          }
        };
        
        const showImage = (newIndex: number) => {
          if (newIndex >= 0 && newIndex < images.length) {
            createLightbox(newIndex);
          }
        };
        
        const keyHandler = (e) => {
          if (e.key === 'Escape') {
            closeLightbox();
          } else if (e.key === 'ArrowLeft' && images.length > 1) {
            e.preventDefault();
            showImage(currentIndex - 1);
          } else if (e.key === 'ArrowRight' && images.length > 1) {
            e.preventDefault();
            showImage(currentIndex + 1);
          }
        };
        
        closeBtn.addEventListener('click', closeLightbox);
        lightbox.addEventListener('click', (e) => {
          if (e.target === lightbox) closeLightbox();
        });
        
        if (prevBtn) {
          prevBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            showImage(currentIndex - 1);
          });
        }
        
        if (nextBtn) {
          nextBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            showImage(currentIndex + 1);
          });
        }
        
        document.addEventListener('keydown', keyHandler);
      }
      
      thumbs.forEach((thumb, index) => {
        thumb.addEventListener('click', () => {
          createLightbox(index);
        });
      });
    });
  }
</script>
