---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ArticleLayout from '../../layouts/ArticleLayout.astro';
import Navigation from '../../components/Navigation.astro';
import HeroMedia from '../../components/article/HeroMedia.astro';
import ArticlePanel from '../../components/article/ArticlePanel.astro';
import RelatedArticles from '../../components/article/RelatedArticles.astro';
import SupportCard from '../../components/SupportCard.astro';
import Footer from '../../components/Footer.astro';
import { getArticleEntry, getRelatedArticles, getPublishedArticles } from '../../lib/articles';
import { projects } from '../../lib/projects';
import { estimateReadingTime, toHttps } from '../../lib/utils';
import { getCollection } from 'astro:content';

// Generate static paths for all published articles
export async function getStaticPaths() {
  const entries = await getCollection('articles', ({ data }) => {
    return data.status === 'published';
  });
  
  return entries.map((entry) => {
    // Remove .md extension from slug
    const slug = entry.id.replace(/\.md$/, '');
    return {
      params: { slug },
      props: { entry },
    };
  });
}

const { entry } = Astro.props;

if (!entry) {
  return Astro.redirect('/magazin');
}

const { Content } = await entry.render();
// Remove .md extension from entry.id for slug
const slug = entry.id.replace(/\.md$/, '');
const article = {
  id: entry.data.id || entry.id,
  title: entry.data.title,
  slug: slug, // Astro automatically generates slug from filename (without .md)
  date: entry.data.date || entry.data.publishedAt || '',
  publishedAt: entry.data.publishedAt || entry.data.date || '',
  status: entry.data.status,
  excerpt: entry.data.excerpt,
  content: entry.body,
  coverImage: (() => {
    const coverImg = (entry.data.coverImage && entry.data.coverImage.trim()) || entry.data.cover?.src;
    // Ignore non-existent files and placeholder.svg, use hero image as fallback
    if (!coverImg || coverImg === '/images/placeholder.svg' || coverImg === '/images/liberec.png' || coverImg === '/images/articles/example.jpg') {
      return '/images/liberec-hero.webp';
    }
    return toHttps(coverImg);
  })(),
  cover: entry.data.cover ? { src: toHttps(entry.data.cover.src), alt: entry.data.cover.alt } : undefined,
  heroCaption: entry.data.heroCaption,
  gallery: entry.data.gallery?.map((g) => ({ src: toHttps(g.src), alt: g.alt })) ?? undefined,
  project: entry.data.project,
  tags: entry.data.tags || [],
  author: entry.data.author,
  sources: entry.data.sources || [],
  audioUrl: entry.data.audioUrl,
  youtubeId: entry.data.youtubeId,
  infographic: entry.data.infographic ? { src: toHttps(entry.data.infographic.src), alt: entry.data.infographic.alt } : undefined,
};

const relatedArticles = await getRelatedArticles(article, 3);
const readingTime = estimateReadingTime(entry.body);

// Get cover image for OG
const ogImage = article.cover?.src || article.coverImage;
const ogImageUrl = ogImage ? new URL(toHttps(ogImage), Astro.site || 'https://memoriaeloci.cz').href : undefined;
---

<BaseLayout 
  title={`${article.title} - Memoriae Loci`}
  description={article.excerpt}
  image={ogImageUrl}
>
  <Navigation />
  
  <ArticleLayout
    title={article.title}
    excerpt={article.excerpt}
    coverImage={article.coverImage}
    cover={article.cover}
    heroCaption={article.heroCaption}
    gallery={article.gallery}
    publishedAt={article.publishedAt || article.date}
    project={article.project}
    tags={article.tags}
    readingTime={readingTime}
  >
    <HeroMedia 
      slot="hero"
      coverImage={article.coverImage}
      cover={article.cover}
      gallery={article.gallery}
      title={article.title}
      coverPosition={slug === 'kdyz-padaly-bomby-utikali-jsme-do-poli' ? 'top' : undefined}
    />
    
    <ArticlePanel 
      slot="panel"
      title={article.title}
      excerpt={article.excerpt}
      publishedAt={article.publishedAt}
      project={article.project}
      tags={article.tags}
      readingTime={readingTime}
      author={article.author}
      sources={article.sources}
      debataLabel={slug === 'kdyz-padaly-bomby-utikali-jsme-do-poli' ? 'Poslechnout si rozhovor' : undefined}
    />
    
    <div slot="content" id="article-content" class="container mx-auto px-4 sm:px-6 lg:px-8 py-12 lg:py-20">
      <article class="article-body prose prose-invert prose-xl max-w-7xl mx-auto
        prose-p:text-slate-200 prose-p:leading-relaxed prose-p:mb-8 prose-p:text-lg prose-p:text-justify
        prose-headings:font-serif prose-headings:text-slate-100 prose-headings:font-bold prose-headings:leading-tight
        prose-h1:text-5xl prose-h1:md:text-6xl prose-h1:mb-6 prose-h1:mt-10
        prose-h2:text-5xl prose-h2:md:text-6xl prose-h2:font-bold prose-h2:mb-6 prose-h2:mt-14 prose-h2:leading-tight
        prose-h3:text-3xl prose-h3:md:text-4xl prose-h3:mb-4 prose-h3:mt-8
        prose-a:text-accent prose-a:no-underline prose-a:border-b prose-a:border-accent/30 hover:prose-a:border-accent prose-a:transition-colors
        prose-strong:text-slate-100 prose-strong:font-semibold
        prose-li:text-slate-200 prose-li:leading-relaxed prose-li:text-lg
        prose-blockquote:border-l-4 prose-blockquote:border-slate-600 prose-blockquote:pl-6 prose-blockquote:italic prose-blockquote:text-slate-300 prose-blockquote:text-lg prose-blockquote:my-12
        prose-img:rounded-lg prose-img:my-10
        prose-code:text-accent prose-code:bg-slate-800/50 prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded
        prose-pre:bg-slate-900 prose-pre:border prose-pre:border-slate-800
        prose-hr:hidden">
        <Content />
      </article>
      <style>
        /* Odstranit všechny hr elementy v článku - absolutní jistota */
        .article-body hr,
        .article-body > hr,
        .article-body * hr {
          display: none !important;
          visibility: hidden !important;
          height: 0 !important;
          margin: 0 !important;
          padding: 0 !important;
          border: none !important;
          opacity: 0 !important;
        }
        /* H2 v článku: větší, tučné, oddělené od textu nad nimi ( :global() aby styly dopadly na H2 z markdownu ) */
        /* Mezery mezi odstavci v článku */
        .article-body :global(p) {
          margin-bottom: 2rem !important;
        }
        .article-body :global(p:last-child) {
          margin-bottom: 0 !important;
        }
        .article-body :global(h2) {
          font-size: 1.125rem !important; /* poloviční – mobil */
          font-weight: 700 !important;
          margin-top: 2.5rem !important;  /* volný řádek / oddělení od odstavce */
          margin-bottom: 1.25rem !important;
          line-height: 1.2 !important;
          color: rgb(241 245 249) !important; /* slate-100 */
        }
        @media (min-width: 768px) {
          .article-body :global(h2) {
            font-size: 1.5rem !important; /* poloviční – desktop */
          }
        }
      </style>
      <!-- Zvuková stopa – shrnutí článku (skript vloží pod první odstavec). Zobrazí se jen když má článek audioUrl. -->
      {article.audioUrl && (
        <div id="article-audio-block" class="article-media-block my-10 max-w-7xl mx-auto rounded-xl border border-slate-700 bg-slate-800/70 overflow-hidden shadow-lg">
          <div class="px-5 py-4 sm:px-6 sm:py-5 flex flex-col sm:flex-row sm:items-center gap-4">
            <div class="flex-shrink-0 sm:min-w-[200px]">
              <h3 class="text-lg font-semibold text-slate-50 leading-tight">Přehrát</h3>
              <p class="text-sm text-slate-400 leading-tight mt-1">Zvuková stopa – přehrávání přímo na webu</p>
            </div>
            <div class="flex-1 min-w-0">
              <audio 
                id="article-audio" 
                class="w-full h-12" 
                controls 
                controlsList="nodownload"
                preload="none"
                style="min-height: 48px;"
              >
                <source src={article.audioUrl} type="audio/wav" />
                <source src={article.audioUrl} type="audio/mp4" />
                <source src={article.audioUrl} type="audio/mpeg" />
                <source src={article.audioUrl} type="audio/ogg" />
                Váš prohlížeč nepodporuje přehrávání audia.
              </audio>
              <p id="article-audio-error" class="text-red-400 text-sm mt-2 hidden" role="alert">
                Zvuk se nenačetl. Zkontrolujte, že je soubor v <code class="bg-slate-800 px-1 rounded">public/audio/</code> – viz návod v projektu.
              </p>
            </div>
          </div>
        </div>
      )}
      <!-- Video a infografika – skript vloží uprostřed článku -->
      <section id="article-video-infographic-section" class="max-w-7xl mx-auto my-16 py-12 border-t border-b border-slate-700" aria-labelledby="video-infographic-heading" style="display: none;">
        <h2 id="video-infographic-heading" class="sr-only">Video a infografika</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-8">
          <!-- Sloupec 1: Video z YouTube -->
          <div class="rounded-lg overflow-hidden border border-slate-700 bg-slate-800/50 aspect-video {!article.youtubeId ? 'flex items-center justify-center text-slate-500' : ''}" aria-hidden={!article.youtubeId}>
            {article.youtubeId ? (
              <iframe
                src={`https://www.youtube.com/embed/${article.youtubeId}`}
                title="Video z YouTube"
                class="w-full h-full"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen
              />
            ) : (
              <div class="text-center p-6 w-full">
                <svg class="w-14 h-14 mx-auto mb-2 opacity-50" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                </svg>
                <p class="text-sm font-medium">Video z YouTube</p>
                <p class="text-xs mt-1">Doplňte frontmatter <code class="text-slate-400 bg-slate-800 px-1 rounded">youtubeId</code></p>
              </div>
            )}
          </div>
          <!-- Sloupec 2: Infografika -->
          <div class="rounded-lg overflow-hidden border border-slate-700 bg-slate-800/50 aspect-video flex items-center justify-center {article.infographic ? '' : 'text-slate-500'}">
            {article.infographic ? (
              <img
                src={article.infographic.src}
                alt={article.infographic.alt}
                class="w-full h-full object-contain object-center p-2"
              />
            ) : (
              <div class="text-center p-6 w-full">
                <svg class="w-14 h-14 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                <p class="text-sm font-medium">Infografika</p>
                <p class="text-xs mt-1">Doplňte frontmatter <code class="text-slate-400 bg-slate-800 px-1 rounded">infographic</code> (src, alt)</p>
              </div>
            )}
          </div>
        </div>
      </section>
    </div>
  </ArticleLayout>
  
  <RelatedArticles articles={relatedArticles} />
  
  <!-- Podpořte nás – stejný blok jako na homepage -->
  <section id="podporte-nas" class="relative py-16 bg-slate-950 scroll-mt-24">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="max-w-7xl mx-auto">
        <SupportCard />
      </div>
    </div>
  </section>
  
  <!-- Partneři vybraných akcí Section -->
  <section class="relative py-16 bg-slate-950">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="max-w-7xl">
        <h2 class="text-2xl md:text-3xl font-bold text-slate-50 mb-8 uppercase tracking-wide">
          Partneři vybraných akcí
        </h2>
        <div class="flex flex-wrap items-center gap-8 md:gap-12">
          <!-- Liberecký kraj logo -->
          <a 
            href="https://www.kraj-lbc.cz" 
            target="_blank"
            rel="noopener noreferrer"
            class="hover:opacity-80 transition-opacity"
          >
            <img 
              src="/images/logo-liberecky-kraj.png" 
              alt="Liberecký kraj"
              class="h-12 brightness-0 invert opacity-80 hover:opacity-100 transition-opacity"
            />
          </a>
          <!-- Krajská vědecká knihovna v Liberci logo -->
          <a 
            href="https://www.kvkli.cz" 
            target="_blank"
            rel="noopener noreferrer"
            class="hover:opacity-80 transition-opacity"
          >
            <img 
              src="/images/logo-kvkli.svg" 
              alt="Krajská vědecká knihovna v Liberci"
              class="h-12 opacity-80 hover:opacity-100 transition-opacity"
            />
          </a>
          <!-- FP TUL logo -->
          <a 
            href="https://www.fp.tul.cz" 
            target="_blank"
            rel="noopener noreferrer"
            class="hover:opacity-80 transition-opacity"
          >
            <img 
              src="https://www.fp.tul.cz/templates/yootheme/cache/d8/FP-znacka-d8bb453b.png" 
              alt="Fakulta přírodovědně-humanitní a pedagogická TUL"
              class="h-12 brightness-0 invert opacity-80 hover:opacity-100 transition-opacity"
            />
          </a>
          <!-- Academia logo -->
          <a 
            href="https://www.academiaknihy.cz" 
            target="_blank"
            rel="noopener noreferrer"
            class="hover:opacity-80 transition-opacity"
          >
            <img 
              src="https://www.academiaknihy.cz/public/dist/images/header-logo-cz--inverse.svg" 
              alt="Nakladatelství Academia"
              class="h-12 opacity-80 hover:opacity-100 transition-opacity"
            />
          </a>
          <!-- Liberecký kraj logo (bílé) -->
          <a 
            href="https://www.kraj-lbc.cz" 
            target="_blank"
            rel="noopener noreferrer"
            class="hover:opacity-80 transition-opacity"
          >
            <img 
              src="/images/logo-liberecky-kraj-6-bile.png" 
              alt="Liberecký kraj"
              class="h-20 opacity-80 hover:opacity-100 transition-opacity"
            />
          </a>
        </div>
      </div>
    </div>
  </section>
  
  <Footer />
</BaseLayout>

<style>
  /* Úvodní odstavec větším písmem */
  .article-body.prose > p:first-of-type {
    font-size: 1.375rem;
    line-height: 1.6;
    color: rgb(226 232 240);
  }

  /* Kotva „Poslechnout si rozhovor“ – scroll s rezervou pod fixní menu */
  #debata {
    scroll-margin-top: 5rem;
  }

  /* Odstranit oddělovače pod zvukovou stopou */
  #article-audio-block + hr {
    display: none !important;
    visibility: hidden !important;
    height: 0 !important;
    margin: 0 !important;
    padding: 0 !important;
    border: none !important;
  }
  
  /* Odstranit hr elementy v následujících elementech */
  #article-audio-block ~ hr {
    display: none !important;
  }
  
  /* Odstranit border-top z elementu následujícího po audio bloku */
  #article-audio-block + * {
    border-top: none !important;
  }
  
  /* Odstranit hr elementy v prose stylu obecně (pro jistotu) */
  .article-body hr {
    display: none !important;
  }

  /* Fade-in animation for content */
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  article {
    animation: fadeIn 0.6s ease-out;
  }
  
  /* Parallax effect for hero image (desktop only) */
  @media (min-width: 1024px) {
    .hero-parallax {
      will-change: transform;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Odstranit všechny hr elementy (oddělovače) z článku
    const article = document.querySelector('.article-body');
    if (article) {
      const hrElements = article.querySelectorAll('hr');
      hrElements.forEach(hr => hr.remove());
      
      // Odstranit odstavce začínající "Tento článek je součástí projektu"
      const paragraphs = article.querySelectorAll('p, em');
      paragraphs.forEach(p => {
        const text = p.textContent?.trim() || '';
        if (text.startsWith('Tento článek je součástí projektu')) {
          p.remove();
        }
      });
    }
    
    // Zvuková stopa (shrnutí) – u článků s „Přepis rozhovoru“ vložit nad ten nadpis, jinak pod první odstavec
    const audioBlock = document.getElementById('article-audio-block');
    if (article && audioBlock) {
      const prepisH2 = Array.from(article.querySelectorAll('h2')).find(h => h.textContent?.trim() === 'Přepis rozhovoru');
      if (prepisH2) {
        // Obálka s kotvou #debata: nadpis „Poslechnout rozhovor“ + audio (scroll sem po kliku na tlačítko)
        const debataWrap = document.createElement('div');
        debataWrap.id = 'debata';
        debataWrap.className = 'scroll-mt-20 max-w-7xl mx-auto';
        const heading = document.createElement('h2');
        heading.className = 'text-slate-100 font-serif font-bold text-2xl md:text-3xl mb-6 mt-14';
        heading.textContent = 'Poslechnout rozhovor';
        prepisH2.parentNode.insertBefore(debataWrap, prepisH2);
        debataWrap.appendChild(heading);
        debataWrap.appendChild(audioBlock);
      } else {
        const firstP = article.querySelector('p');
        const insertAfter = firstP || article.querySelector('h1, h2') || article.firstElementChild;
        if (insertAfter) {
          insertAfter.after(audioBlock);
        }
      }
      // Odstranit hr element (oddělovač) hned po audio bloku (pokud se ještě objevil)
      const nextSibling = audioBlock.nextElementSibling;
      if (nextSibling && nextSibling.tagName === 'HR') {
        nextSibling.remove();
      }
      if (nextSibling) {
        const hrInNext = nextSibling.querySelector('hr');
        if (hrInNext) hrInNext.remove();
      }
    }

    // Když se zvuk nenačte (404, CORS, …), zobrazit hlášku
    const audioEl = document.getElementById('article-audio');
    const audioErrorEl = document.getElementById('article-audio-error');
    if (audioEl && audioErrorEl) {
      audioEl.addEventListener('error', () => {
        audioErrorEl.classList.remove('hidden');
      });
      audioEl.addEventListener('canplaythrough', () => {
        audioErrorEl.classList.add('hidden');
      });
    }

    // Video a infografika: vložit před nadpis „Rozsudek“ (sekce s videem a obrázkem nad Rozsudkem)
    const videoInfographicSection = document.getElementById('article-video-infographic-section');
    if (article && videoInfographicSection) {
      const rozsudekH2 = Array.from(article.querySelectorAll('h2')).find(h => h.textContent?.trim() === 'Rozsudek');
      if (rozsudekH2) {
        rozsudekH2.id = 'debata'; // cíl pro tlačítko „Debata“ v panelu
        rozsudekH2.parentNode.insertBefore(videoInfographicSection, rozsudekH2);
        videoInfographicSection.style.display = 'block';
      } else {
        // Fallback: vložit přibližně uprostřed
        const contentElements = Array.from(article.children).filter(el => {
          const tagName = el.tagName.toLowerCase();
          return ['p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'ul', 'ol', 'blockquote', 'figure', 'img'].includes(tagName);
        });
        if (contentElements.length > 0) {
          const middleIndex = Math.floor(contentElements.length / 2);
          const middleElement = contentElements[middleIndex];
          if (middleElement?.nextSibling) {
            middleElement.parentNode.insertBefore(videoInfographicSection, middleElement.nextSibling);
          } else if (middleElement) {
            middleElement.after(videoInfographicSection);
          }
          videoInfographicSection.style.display = 'block';
        }
      }
    }

    // Subtle parallax effect for hero image (desktop only)
    if (window.innerWidth >= 1024) {
      const hero = document.querySelector('.hero-media-container');
      const panel = document.querySelector('[slot="panel"]')?.parentElement;
      if (hero && panel) {
        const heroImg = hero.querySelector('.hero-image');
        if (heroImg) {
          panel.addEventListener('scroll', () => {
            const scrollTop = panel.scrollTop;
            const parallaxSpeed = 0.2;
            heroImg.style.transform = `translateY(${scrollTop * parallaxSpeed}px)`;
          }, { passive: true });
        }
      }
    }
  });
</script>
