---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ArticleLayout from '../../layouts/ArticleLayout.astro';
import Navigation from '../../components/Navigation.astro';
import HeroMedia from '../../components/article/HeroMedia.astro';
import ArticlePanel from '../../components/article/ArticlePanel.astro';
import RelatedArticles from '../../components/article/RelatedArticles.astro';
import Footer from '../../components/Footer.astro';
import { getArticleEntry, getRelatedArticles, getPublishedArticles } from '../../lib/articles';
import { projects } from '../../lib/projects';
import { estimateReadingTime } from '../../lib/utils';
import { getCollection } from 'astro:content';

// Generate static paths for all published articles
export async function getStaticPaths() {
  const entries = await getCollection('articles', ({ data }) => {
    return data.status === 'published';
  });
  
  return entries.map((entry) => {
    // Remove .md extension from slug
    const slug = entry.id.replace(/\.md$/, '');
    return {
      params: { slug },
      props: { entry },
    };
  });
}

const { entry } = Astro.props;

if (!entry) {
  return Astro.redirect('/magazin');
}

const { Content } = await entry.render();
// Remove .md extension from entry.id for slug
const slug = entry.id.replace(/\.md$/, '');
const article = {
  id: entry.data.id || entry.id,
  title: entry.data.title,
  slug: slug, // Astro automatically generates slug from filename (without .md)
  date: entry.data.date || entry.data.publishedAt || '',
  publishedAt: entry.data.publishedAt || entry.data.date || '',
  status: entry.data.status,
  excerpt: entry.data.excerpt,
  content: entry.body,
  coverImage: (() => {
    const coverImg = (entry.data.coverImage && entry.data.coverImage.trim()) || entry.data.cover?.src;
    // Ignore non-existent files and placeholder.svg, use hero image as fallback
    if (!coverImg || coverImg === '/images/placeholder.svg' || coverImg === '/images/liberec.png' || coverImg === '/images/articles/example.jpg') {
      return '/images/liberec-hero.webp';
    }
    return coverImg;
  })(),
  cover: entry.data.cover,
  heroCaption: entry.data.heroCaption,
  gallery: entry.data.gallery,
  project: entry.data.project,
  tags: entry.data.tags || [],
  author: entry.data.author,
  sources: entry.data.sources || [],
};

const relatedArticles = await getRelatedArticles(article, 3);
const readingTime = estimateReadingTime(entry.body);

// Get cover image for OG
const ogImage = article.cover?.src || article.coverImage;
const ogImageUrl = ogImage ? new URL(ogImage, Astro.site || 'https://memoriaeloci.cz').href : undefined;
---

<BaseLayout 
  title={`${article.title} - Memoriae Loci`}
  description={article.excerpt}
  image={ogImageUrl}
>
  <Navigation />
  
  <ArticleLayout
    title={article.title}
    excerpt={article.excerpt}
    coverImage={article.coverImage}
    cover={article.cover}
    heroCaption={article.heroCaption}
    gallery={article.gallery}
    publishedAt={article.publishedAt || article.date}
    project={article.project}
    tags={article.tags}
    readingTime={readingTime}
  >
    <HeroMedia 
      slot="hero"
      coverImage={article.coverImage}
      cover={article.cover}
      gallery={article.gallery}
      title={article.title}
    />
    
    <ArticlePanel 
      slot="panel"
      title={article.title}
      excerpt={article.excerpt}
      publishedAt={article.publishedAt}
      project={article.project}
      tags={article.tags}
      readingTime={readingTime}
      author={article.author}
      sources={article.sources}
    />
    
    <div slot="content" id="article-content" class="container mx-auto px-4 sm:px-6 lg:px-8 py-12 lg:py-20">
      <article class="prose prose-invert prose-xl max-w-7xl mx-auto
        prose-p:text-slate-200 prose-p:leading-relaxed prose-p:mb-8 prose-p:text-lg prose-p:text-justify
        prose-headings:font-serif prose-headings:text-slate-100 prose-headings:font-bold prose-headings:leading-tight
        prose-h1:text-5xl prose-h1:mb-8 prose-h1:mt-12 prose-h1:border-b prose-h1:border-slate-700 prose-h1:pb-6
        prose-h2:text-4xl prose-h2:mb-6 prose-h2:mt-12 prose-h2:border-b prose-h2:border-slate-700 prose-h2:pb-4
        prose-h3:text-3xl prose-h3:mb-5 prose-h3:mt-10
        prose-a:text-accent prose-a:no-underline prose-a:border-b prose-a:border-accent/30 hover:prose-a:border-accent prose-a:transition-colors
        prose-strong:text-slate-100 prose-strong:font-semibold
        prose-li:text-slate-200 prose-li:leading-relaxed prose-li:text-lg
        prose-blockquote:border-l-4 prose-blockquote:border-slate-600 prose-blockquote:pl-6 prose-blockquote:italic prose-blockquote:text-slate-300 prose-blockquote:text-lg
        prose-img:rounded-lg prose-img:my-10
        prose-code:text-accent prose-code:bg-slate-800/50 prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded
        prose-pre:bg-slate-900 prose-pre:border prose-pre:border-slate-800
        prose-hr:border-slate-700 prose-hr:my-12">
        <Content />
      </article>
    </div>
  </ArticleLayout>
  
  <RelatedArticles articles={relatedArticles} />
  
  <!-- Partneři vybraných akcí Section -->
  <section class="relative py-16 bg-slate-950">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="max-w-7xl">
        <h2 class="text-2xl md:text-3xl font-bold text-slate-50 mb-8 uppercase tracking-wide">
          Partneři vybraných akcí
        </h2>
        <div class="flex flex-wrap items-center gap-8 md:gap-12">
          <!-- Liberecký kraj logo -->
          <a 
            href="https://www.kraj-lbc.cz" 
            target="_blank"
            rel="noopener noreferrer"
            class="hover:opacity-80 transition-opacity"
          >
            <img 
              src="/images/logo-liberecky-kraj.png" 
              alt="Liberecký kraj"
              class="h-12 brightness-0 invert opacity-80 hover:opacity-100 transition-opacity"
            />
          </a>
          <!-- Krajská vědecká knihovna v Liberci logo -->
          <a 
            href="https://www.kvkli.cz" 
            target="_blank"
            rel="noopener noreferrer"
            class="hover:opacity-80 transition-opacity"
          >
            <img 
              src="/images/logo-kvkli.svg" 
              alt="Krajská vědecká knihovna v Liberci"
              class="h-12 opacity-80 hover:opacity-100 transition-opacity"
            />
          </a>
          <!-- FP TUL logo -->
          <a 
            href="https://www.fp.tul.cz" 
            target="_blank"
            rel="noopener noreferrer"
            class="hover:opacity-80 transition-opacity"
          >
            <img 
              src="https://www.fp.tul.cz/templates/yootheme/cache/d8/FP-znacka-d8bb453b.png" 
              alt="Fakulta přírodovědně-humanitní a pedagogická TUL"
              class="h-12 brightness-0 invert opacity-80 hover:opacity-100 transition-opacity"
            />
          </a>
          <!-- Academia logo -->
          <a 
            href="https://www.academiaknihy.cz" 
            target="_blank"
            rel="noopener noreferrer"
            class="hover:opacity-80 transition-opacity"
          >
            <img 
              src="https://www.academiaknihy.cz/public/dist/images/header-logo-cz--inverse.svg" 
              alt="Nakladatelství Academia"
              class="h-12 opacity-80 hover:opacity-100 transition-opacity"
            />
          </a>
          <!-- Liberecký kraj logo (bílé) -->
          <a 
            href="https://www.kraj-lbc.cz" 
            target="_blank"
            rel="noopener noreferrer"
            class="hover:opacity-80 transition-opacity"
          >
            <img 
              src="/images/logo-liberecky-kraj-6-bile.png" 
              alt="Liberecký kraj"
              class="h-20 opacity-80 hover:opacity-100 transition-opacity"
            />
          </a>
        </div>
      </div>
    </div>
  </section>
  
  <Footer />
</BaseLayout>

<style>
  /* Fade-in animation for content */
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  article {
    animation: fadeIn 0.6s ease-out;
  }
  
  /* Parallax effect for hero image (desktop only) */
  @media (min-width: 1024px) {
    .hero-parallax {
      will-change: transform;
    }
  }
</style>

<script>
  // Subtle parallax effect for hero image (desktop only)
  if (typeof window !== 'undefined' && window.innerWidth >= 1024) {
    document.addEventListener('DOMContentLoaded', () => {
      const hero = document.querySelector('.hero-media-container');
      const panel = document.querySelector('[slot="panel"]')?.parentElement;
      
      if (hero && panel) {
        const heroImg = hero.querySelector('.hero-image');
        if (heroImg) {
          panel.addEventListener('scroll', () => {
            const scrollTop = panel.scrollTop;
            const parallaxSpeed = 0.2; // Subtle effect
            heroImg.style.transform = `translateY(${scrollTop * parallaxSpeed}px)`;
          }, { passive: true });
        }
      }
    });
  }
</script>
